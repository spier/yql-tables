<?xml version="1.0" encoding="UTF-8"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd" https="true">
	<meta>
		<author>Sebastian Spier (http://twitter.com/#!/sebastianspier/)</author>
		<description>Outside.in Hyperlocal News API</description>
		<documentationURL>http://developers.outside.in/docs/read/stories_query_resource</documentationURL>
		<sampleQuery>SELECT * FROM {table} WHERE dev_key="a" AND secret="b" AND state="florida"</sampleQuery>
	</meta>
	<bindings>
		<select itemPath="json" produces="JSON">
			<urls>
				<!-- http://hyperlocal-api.outside.in/v1.1/states/{state abbreviation}/stories?dev_key={key}&sig={signature} -->
				<url>http://hyperlocal-api.outside.in/v1.1/states/{state}/stories</url>
			</urls>
			<inputs>
				<key id="dev_key" type="xs:string" paramType="variable" required="true" />
				<key id="secret" type="xs:string" paramType="variable" required="true" />
				
				<!-- either abbreviation or name of state -->
				<key id="state" type="xs:string" paramType="path" required="true"/>
			</inputs>
			<execute><![CDATA[
				
				function Crypto() {}

				Crypto.strToBe32s = function(str)
				{
					var be=[];
					var len=Math.floor(str.length/4);
					var i, j;
					for(i=0, j=0; i<len; i++, j+=4) {
						be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
					}
					while(j<str.length) {
						be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
						j++;
					}
					return be;
				};
				
				Crypto.be32sToHex = function(be)
				{
					var hex='0123456789ABCDEF';
					var str='';
					for(var i=0;i<be.length*4;i++) {
						str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
					}
					return str;
				};
				
				
				
				
				
				
				// create my own window object
				//var window = {};
				// MD5 hashing from crypto-js
				//y.include("http://crypto-js.googlecode.com/files/2.3.0-crypto-md5.js");
		
				// create signature
				var hm = dev_key + secret + (Math.round(new Date().getTime() / 1000).toString());
				y.log(hm);

				var sig = y.crypto.encodeMd5(hm);
				y.log(sig);
				
				var sig2 = Crypto.be32sToHex( Crypto.strToBe32s(hm) );
				y.log(sig2);
				
				// make request
				response.object = request.query("dev_key",dev_key).query("sig",sig2).get().response;

				]]></execute>
			</select>
		</bindings>
	</table>